
'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var data=void 0;var reviews=void 0;var DBHelper=function(){function DBHelper(){_classCallCheck(this,DBHelper);}
_createClass(DBHelper,null,[{key:'fetchReviews',value:function fetchReviews(){var id=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'';return new Promise(function(resolve,reject){var dbPromise=DBHelper.initializeDB();dbPromise.then(function(db){var tx=db.transaction(db.objectStoreNames,'readonly');var key=id!==''&&id>0?parseInt(id):'';tx.objectStore('reviews').index('restaurant_id').getAll(key).then(function(reviews){if(reviews.length===0){fetch('http://localhost:1337/reviews/'+(id!==''&&id>0?'?restaurant_id='+id:'')).then(function(response){return response.json();}).then(function(reviews){dbPromise.then(function(db){var tx=db.transaction('reviews','readwrite');var objectStore=tx.objectStore('reviews');reviews.forEach(function(review){objectStore.put(review);});resolve(reviews);});});}else{resolve(reviews);};});});});}},{key:'fetchRestaurants',value:function fetchRestaurants(){return new Promise(function(resolve,reject){var dbPromise=DBHelper.initializeDB();dbPromise.then(function(db){var tx=db.transaction(db.objectStoreNames,'readonly');tx.objectStore('restaurants').getAll().then(function(data){if(data.length===0){fetch(DBHelper.DATABASE_URL).then(function(response){return response.json();}).then(function(restaurants){dbPromise.then(function(db){var tx=db.transaction('restaurants','readwrite');var objectStore=tx.objectStore('restaurants');restaurants.forEach(function(restaurant){objectStore.put(restaurant);});resolve(restaurants);});});}else{resolve(data);};});});});}},{key:'initializeDB',value:function initializeDB(){var dbPromise=idb.open('restaurants',1,function(upgradeDb){if(!upgradeDb.objectStoreNames.contains('restaurants')){var restaurantsObject=upgradeDb.createObjectStore('restaurants',{keyPath:'id'});restaurantsObject.createIndex('offline','offline',{unique:false});var reviewsObject=upgradeDb.createObjectStore('reviews',{keyPath:'id'});reviewsObject.createIndex('restaurant_id','restaurant_id',{unique:false});reviewsObject.createIndex('offline','offline',{unique:false});}});return dbPromise;}},{key:'setFavorite',value:function setFavorite(id,isFavorite){if(navigator.onLine){fetch(DBHelper.DATABASE_URL+'/'+id+'/?is_favorite='+isFavorite,{method:'PUT'}).then(function(response){if(response.ok){response.json().then(function(restaurant){DBHelper.initializeDB().then(function(db){var tx=db.transaction('restaurants','readwrite');var objectStore=tx.objectStore('restaurants');objectStore.put(restaurant);});});}});}else{DBHelper.initializeDB().then(function(db){var tx=db.transaction('restaurants','readwrite');var objectStore=tx.objectStore('restaurants');objectStore.openCursor(id).then(function(cursor){var restaurant=cursor._cursor.value;restaurant.is_favorite=isFavorite;restaurant.offline=1;if(cursor===undefined){objectStore.add(restaurant);}else{cursor.update(restaurant);}});});}}},{key:'addReview',value:function addReview(restaurant_id,name,rating,comments){return new Promise(function(resolve,reject){var review={restaurant_id:restaurant_id,name:name,rating:rating,comments:comments};if(navigator.onLine){fetch('http://localhost:1337/reviews/',{method:'POST',body:JSON.stringify(review)}).then(function(response){if(response.ok){response.json().then(function(review){DBHelper.initializeDB().then(function(db){var tx=db.transaction('reviews','readwrite');var objectStore=tx.objectStore('reviews');objectStore.put(review);resolve(review);});});}}).catch(function(error){DBHelper.addReviewToIndexedDb(review).then(function(review){return resolve(review);});});}else{DBHelper.addReviewToIndexedDb(review).then(function(review){return resolve(review);});}});}},{key:'fetchReview',value:function fetchReview(review){return new Promise(function(resolve){fetch('http://localhost:1337/reviews/',{method:'POST',body:JSON.stringify(review)}).then(function(response){return resolve(response);});});}},{key:'addReviewToIndexedDb',value:function addReviewToIndexedDb(review){return new Promise(function(resolve){review.offline=1;review.id=Date.now();DBHelper.initializeDB().then(function(db){var tx=db.transaction('reviews','readwrite');var objectStore=tx.objectStore('reviews');objectStore.add(review);});resolve(review);});}},{key:'fetchRestaurantById',value:function fetchRestaurantById(id){return new Promise(function(resolve,reject){DBHelper.fetchRestaurants().then(function(restaurants){var restaurant=restaurants.find(function(r){return r.id==id;});if(restaurant){DBHelper.fetchReviews(id).then(function(reviews){self.reviews=reviews;resolve(restaurant);});}else{reject('Restaurant does not exist');}}).catch(function(error){console.log(error);});});}},{key:'fetchRestaurantByCuisine',value:function fetchRestaurantByCuisine(cuisine,callback){return new Promise(function(resolve,reject){DBHelper.fetchRestaurants().then(function(restaurants){var results=restaurants.filter(function(r){return r.cuisine_type==cuisine;});resolve(results);}).catch(function(error){console.log(error);});});}},{key:'fetchRestaurantByNeighborhood',value:function fetchRestaurantByNeighborhood(neighborhood,callback){DBHelper.fetchRestaurants().then(function(restaurants){var results=restaurants.filter(function(r){return r.neighborhood==neighborhood;});return results;}).catch(function(error){console.log(error);});}},{key:'fetchRestaurantByCuisineAndNeighborhood',value:function fetchRestaurantByCuisineAndNeighborhood(cuisine,neighborhood,callback){DBHelper.fetchRestaurants().then(function(restaurants){var results=restaurants;if(cuisine!='all'){results=results.filter(function(r){return r.cuisine_type==cuisine;});}
if(neighborhood!='all'){results=results.filter(function(r){return r.neighborhood==neighborhood;});}
callback(null,results);}).catch(function(error){console.log(error);});}},{key:'fetchNeighborhoods',value:function fetchNeighborhoods(callback){DBHelper.fetchRestaurants().then(function(restaurants){var neighborhoods=restaurants.map(function(v,i){return restaurants[i].neighborhood;});var uniqueNeighborhoods=neighborhoods.filter(function(v,i){return neighborhoods.indexOf(v)==i;});callback(null,uniqueNeighborhoods);}).catch(function(error){console.log(error);});}},{key:'fetchCuisines',value:function fetchCuisines(callback){DBHelper.fetchRestaurants().then(function(restaurants){var cuisines=restaurants.map(function(v,i){return restaurants[i].cuisine_type;});var uniqueCuisines=cuisines.filter(function(v,i){return cuisines.indexOf(v)==i;});callback(null,uniqueCuisines);}).catch(function(error){console.log(error);});}},{key:'urlForRestaurant',value:function urlForRestaurant(restaurant){return'./restaurant.html?id='+restaurant.id;}},{key:'imageUrlForRestaurant',value:function imageUrlForRestaurant(restaurant){var small=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'';return restaurant.photograph?'dist/img/'+restaurant.photograph+small+'.jpeg':'dist/img/'+restaurant.id+small+'.jpeg';}},{key:'mapMarkerForRestaurant',value:function mapMarkerForRestaurant(restaurant,map){var marker=new google.maps.Marker({position:restaurant.latlng,title:restaurant.name,url:DBHelper.urlForRestaurant(restaurant),map:map,animation:google.maps.Animation.DROP});return marker;}},{key:'DATABASE_URL',get:function get(){var port=1337;return'http://localhost:'+port+'/restaurants';}}]);return DBHelper;}();;